<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analisis All Cabang Bone Hacker</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    :root {
      --text-color: #111827;
      --bg-color: #ffffff;
      --card-bg: #ffffff;
      --border-color: #374151;
      --chart-grid: rgba(96, 165, 250, 0.2);
      --table-bg: #ffffff;
      --table-border: #374151;
      --shadow-color: rgba(0, 0, 0, 0.1);
    }
    
    .dark {
      --text-color: #f3f4f6;
      --bg-color: #111827;
      --card-bg: #1f2937;
      --border-color: #e5e7eb;
      --chart-grid: rgba(96, 165, 250, 0.1);
      --table-bg: #1f2937;
      --table-border: #e5e7eb;
      --shadow-color: rgba(0, 0, 0, 0.4);
    }
    
    body {
      font-family: 'Inter', Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    
    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    
    .contrast-table th, .contrast-table td {
      border: 1px solid var(--table-border);
      background-color: var(--table-bg);
      color: var(--text-color);
      font-size: 0.85rem;
      text-align: center;
      padding: 0.4rem 0.6rem;
      white-space: nowrap;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    
    .contrast-table th {
      font-weight: 700;
      cursor: pointer;
    }
    
    .contrast-table th.sorted-asc::after { content: " ▲"; }
    .contrast-table th.sorted-desc::after { content: " ▼"; }
    
    .dropdown {
      border: 1px solid var(--border-color);
      border-radius: 0.375rem;
      padding: 0.5rem 0.75rem;
      min-width: 140px;
      background: var(--card-bg);
      color: var(--text-color);
      font-weight: 600;
      font-size: 0.95rem;
      white-space: nowrap;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    
    .btn-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: var(--border-color);
      color: var(--bg-color);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      cursor: pointer;
      font-weight: 700;
      z-index: 1000;
      transition: background-color 0.3s;
    }
    
    .btn-toggle:hover { 
      opacity: 0.9; 
    }
    
    a.main-linktree {
      background: var(--text-color);
      color: var(--bg-color);
      font-weight: 700;
      padding: 0.75rem 1.25rem;
      border-radius: 9999px;
      text-align: center;
      display: inline-block;
      box-shadow: 0 4px 6px var(--shadow-color);
      transition: all 0.3s;
    }
    
    a.main-linktree:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 8px var(--shadow-color);
    }
    
    .scroll-container {
      overflow-x: auto;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      padding: 0.5rem 0;
      border-radius: 0.5rem;
    }
    
    /* Tooltip styles */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* Improved mobile view */
    @media (max-width: 640px) {
      .metrics-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      
      .contrast-table th, 
      .contrast-table td {
        font-size: 0.8rem;
        padding: 0.4rem 0.5rem;
      }
      
      .dropdown {
        font-size: 0.9rem;
        padding: 0.4rem 0.6rem;
      }
      
      .card {
        padding: 0.75rem;
      }
      
      .scroll-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 0.5rem;
        color: var(--text-color);
        opacity: 0.7;
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0% { opacity: 0.4; }
        50% { opacity: 0.8; }
        100% { opacity: 0.4; }
      }
    }
  </style>
</head>
<body>

<main class="container mx-auto px-3 py-6 max-w-7xl">
  <header class="mb-6 text-center">
    <h1 class="text-3xl font-extrabold mb-3">Analisis All Cabang</h1>
    <p class="text-xl font-semibold mb-2">BONE HACKER <span id="bulanHeader">MEI 2025</span></p>
    <div class="flex flex-wrap justify-center items-center gap-3 mb-3">
      <label class="font-bold text-lg" for="bulanPicker">Pilih Bulan:</label>
      <select id="bulanPicker" class="dropdown">
        <option value="april">April 2025</option>
        <option value="mei">Mei 2025</option>
        <option value="juni">Juni 2025</option>
        <option value="juli">Juli 2025</option>
        <option value="agustus">Agustus 2025</option>
        <option value="september">September 2025</option>
        <option value="oktober">Oktober 2025</option>
      </select>
    </div>
    <p id="todayDate" class="text-sm mt-2 opacity-80"></p>
  </header>

  <section class="grid metrics-grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8 text-center">
    <div class="card p-4">
      <div class="text-3xl sm:text-4xl font-extrabold" id="totalPasien">-</div>
      <div class="font-semibold mt-1">Total Pasien</div>
    </div>
    <div class="card p-4">
      <div class="text-3xl sm:text-4xl font-extrabold text-green-600 dark:text-green-400" id="pasienBaru">-</div>
      <div class="font-semibold mt-1">Pasien Baru</div>
    </div>
    <div class="card p-4">
      <div class="text-3xl sm:text-4xl font-extrabold text-blue-600 dark:text-blue-400" id="pasienLama">-</div>
      <div class="font-semibold mt-1">Pasien Lama</div>
    </div>
    <div class="card p-4">
      <div class="text-3xl sm:text-4xl font-extrabold text-orange-600 dark:text-orange-400" id="rataRata">-</div>
      <div class="font-semibold mt-1">Rata-rata/Hari</div>
    </div>
  </section>

  <div class="mb-6 text-center text-sm">
    <span id="persenBaru" class="font-semibold px-2 py-1 rounded bg-green-100 dark:bg-green-900"></span>
    <span class="mx-2">|</span>
    <span id="persenLama" class="font-semibold px-2 py-1 rounded bg-blue-100 dark:bg-blue-900"></span>
  </div>

  <section class="card mb-8 p-5">
    <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
      <h2 class="text-xl font-bold flex-grow">Jumlah Pasien per Cabang</h2>
      <select id="chartCabangDropdown" class="dropdown">
        <option value="total">Total (Hitam)</option>
        <option value="baru">Pasien Baru (Hijau)</option>
        <option value="lama">Pasien Lama (Biru)</option>
      </select>
    </div>
    <div class="chart-container" style="position: relative; height:300px;">
      <canvas id="chartCabang"></canvas>
    </div>
  </section>

  <section class="card mb-8 p-5">
    <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
      <h2 class="text-xl font-bold flex-grow">Sumber Informasi Pasien</h2>
      <div class="flex flex-wrap gap-2">
        <select id="chartSumberDropdown" class="dropdown">
          <option value="all">Semua Cabang</option>
        </select>
        <select id="chartSumberJenisDropdown" class="dropdown" disabled>
          <option value="all">Semua Sumber</option>
        </select>
      </div>
    </div>
    <div class="chart-container" style="position: relative; height:300px;">
      <canvas id="chartSumber"></canvas>
    </div>
  </section>

  <section class="card mb-8 p-5">
    <h2 class="text-xl font-bold mb-4 text-center">Tabel Data All Cabang</h2>
    <div class="scroll-indicator sm:hidden">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
        <polyline points="9 18 3 12 9 6"></polyline>
      </svg>
      <span class="ml-1">Geser untuk melihat lebih banyak</span>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
        <polyline points="15 18 21 12 15 6"></polyline>
      </svg>
    </div>
    <div class="scroll-container">
      <table id="tableBranch" class="min-w-full contrast-table text-sm">
        <thead>
          <tr>
            <th>Cabang</th>
            <th data-sort="number" class="sortable">Rata²/Hari</th>
            <th data-sort="number" class="sortable">Jumlah Pasien</th>
            <th data-sort="number" class="sortable">Pasien Lama</th>
            <th data-sort="number" class="sortable">Pasien Baru</th>
            <th data-sort="number" class="sortable">% Lama</th>
            <th data-sort="number" class="sortable">% Baru</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card mb-8 p-5">
    <h2 class="text-xl font-bold mb-4 text-center">Tabel Sumber Informasi per Cabang</h2>
    <div class="scroll-indicator sm:hidden">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
        <polyline points="9 18 3 12 9 6"></polyline>
      </svg>
      <span class="ml-1">Geser untuk melihat lebih banyak</span>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
        <polyline points="15 18 21 12 15 6"></polyline>
      </svg>
    </div>
    <div class="scroll-container">
      <table id="tableSumber" class="min-w-full contrast-table text-sm">
        <thead>
          <tr></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <div class="flex justify-center mb-8">
    <a href="https://bonehacker.com/allcabang/" target="_blank" rel="noopener" 
       class="main-linktree px-6 py-3 text-lg">
      Lihat Daftar Antrian Hari Ini
    </a>
  </div>
</main>
<script>
  // Map bulan ke API Web App
  const API_MAP = {
    april: 'https://script.google.com/macros/s/AKfycby6jW-vmVgRKlBlW-gBKLfnE4FLfDkM-jxzG4kgs1mgL7IJlwlFIX0j7hNomihzaQH2jg/exec',
    mei:   'https://script.google.com/macros/s/AKfycbx5tHgTXzn0A1uxdjCYMLpb79DuURMTsNPXqPd0tLn4DG3UbtlygovWEFq73k2AdAuP/exec',
    juni:  'https://script.google.com/macros/s/AKfycbxzZWtyyfcQY3tFOyZ9fxhx6j81Kfdh7QjJvoXZCA0k9MPgOldmgSvqP_GZPvccmHPJ/exec',
    juli:  'https://script.google.com/macros/s/AKfycbzxi0ObtvJVuLJoSQwMrGHCWpnZeyPpwLD5fk8k9CCNJyCqS2m007l0mzgaDn9P3ilW/exec',
    agustus: 'https://script.google.com/macros/s/AKfycbx6-6futXmN2zM8qzIDiGUll_ShEYedkFUc_q-SodbtzghIT3xRiYwm5a3eRCvUor8r0g/exec',
    september: 'https://script.google.com/macros/s/AKfycbz8STQxgLZWJCxpVgc46CFivzlKXlPRn3T2QcWamZ8GEY0dUJr2v4jDq78csiD9goZc/exec',
    oktober: 'https://script.google.com/macros/s/AKfycbzMjq1OdGnQA8DevTAG7U2aGXkvYUKH-8o1dczTuWIaXn3W6NuXzsakapevzgk5My4LnA/exec'
  };

  const bulanLabel = {
    april: "APRIL 2025",
    mei: "MEI 2025",
    juni: "JUNI 2025",
    juli: "JULI 2025",
    agustus: "AGUSTUS 2025",
    september: "SEPTEMBER 2025",
    oktober: "OKTOBER 2025"
  };

  // Tanggal hari ini
  const today = new Date();
  const options = { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' };
  document.getElementById('todayDate').textContent = 'Tanggal: ' + today.toLocaleDateString('id-ID', options);

  // Ambil nama bulan otomatis dari tanggal sekarang
  const monthMap = ['januari', 'februari', 'maret', 'april', 'mei', 'juni', 'juli', 'agustus', 'september', 'oktober', 'november', 'desember'];
  const currentMonth = today.getMonth(); // 0-11
  let currentBulan = monthMap[currentMonth];

  // Jika bulan belum tersedia di API_MAP, fallback ke 'mei'
  if (!API_MAP[currentBulan]) {
    currentBulan = 'mei';
  }

  let currentApi = API_MAP[currentBulan];
  
  // Set dropdown ke bulan saat ini
  document.getElementById('bulanPicker').value = currentBulan;
  
  // Perbarui header bulan
  document.getElementById('bulanHeader').textContent = bulanLabel[currentBulan];

  document.getElementById('bulanPicker').addEventListener('change', function() {
    currentBulan = this.value;
    currentApi = API_MAP[currentBulan];
    document.getElementById('bulanHeader').textContent = bulanLabel[currentBulan];
    loadData();
  });

  const chartColors = {
    total: getComputedStyle(document.body).getPropertyValue('--text-color') || "#222",
    baru: "#16a34a",
    lama: "#2563eb",
    teman: "#facc15",
    tiktok: "#a21caf",
    facebook: "#2563eb",
    lewat: "#6b7280",
    instagram: "#fd7e14",
    google: "#22c55e",
    youtube: "#ef4444"
  };

  const sumberOrder = ["TEMAN/KERABAT","TIKTOK","FACEBOOK","LEWAT","INSTAGRAM","GOOGLE","YOUTUBE"];
  const sumberColorArr = [
    chartColors.teman, chartColors.tiktok, chartColors.facebook, chartColors.lewat,
    chartColors.instagram, chartColors.google, chartColors.youtube
  ];

  let globalData;
  let chartCabang, chartSumber;

  function loadData() {
    const loadingIndicator = document.createElement('div');
    loadingIndicator.classList.add('fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'bg-black', 'bg-opacity-50', 'z-50');
    loadingIndicator.innerHTML = `
      <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow-lg text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-blue-500 mx-auto mb-3"></div>
        <p class="text-lg font-medium">Memuat Data...</p>
      </div>
    `;
    document.body.appendChild(loadingIndicator);

    fetch(currentApi)
      .then(r => r.json())
      .then(data => {
        document.body.removeChild(loadingIndicator);
        globalData = data;

        // --- MODIFIKASI: HAPUS JOGJA JIKA BULAN OKTOBER ---
        if (currentBulan === 'oktober') {
          if (globalData.branches) {
            globalData.branches = globalData.branches.filter(branch => branch.cabang !== 'JOGJA');
          }
          if (globalData.cabangList) {
            globalData.cabangList = globalData.cabangList.filter(cabang => cabang !== 'JOGJA');
          }
          if (globalData.sumberPerCabang && globalData.sumberPerCabang.JOGJA) {
            delete globalData.sumberPerCabang.JOGJA;
          }
        }
        // --- AKHIR MODIFIKASI ---

        // --- PERBAIKAN: Hitung ulang total untuk "Semua Cabang" di sisi klien ---
        // Ini untuk memastikan data "Semua Cabang" di chart adalah total yang benar,
        // dan mengatasi masalah di mana data hanya menunjukkan satu cabang.
        const recalculatedSumberList = [];
        if (data.sumberLabels && data.sumberLabels.length > 0 && data.cabangList && data.cabangList.length > 0) {
            for (let i = 0; i < data.sumberLabels.length; i++) {
                let totalPerSumber = 0;
                for (const namaCabang of data.cabangList) {
                    if (data.sumberPerCabang[namaCabang] && data.sumberPerCabang[namaCabang][i] !== undefined) {
                        totalPerSumber += data.sumberPerCabang[namaCabang][i];
                    }
                }
                recalculatedSumberList.push(totalPerSumber);
            }
            // Ganti data `sumberList` dari server dengan data yang sudah dihitung ulang dan akurat.
            globalData.sumberList = recalculatedSumberList;
        }
        // --- AKHIR PERBAIKAN ---

        // Ringkasan
        document.getElementById('totalPasien').textContent = data.total.jumlahPasien;
        document.getElementById('pasienBaru').textContent = data.total.pasienBaru;
        document.getElementById('pasienLama').textContent = data.total.pasienLama;
        document.getElementById('rataRata').textContent = Math.round(data.total.rataRataPerHari);
        
        document.getElementById('persenBaru').textContent = 'Pasien Baru: ' + (data.total.persenBaru*100).toFixed(1) + '%';
        document.getElementById('persenLama').textContent = 'Pasien Lama: ' + (data.total.persenLama*100).toFixed(1) + '%';

        // Tabel All Cabang
        populateTable('tableBranch', data.branches);

        // Tabel Sumber Informasi
        populateTableSumber('tableSumber', data.sumberTabel, data.cabangList);

        // Dropdown Chart Jumlah Pasien
        const chartCabangDropdown = document.getElementById('chartCabangDropdown');
        chartCabangDropdown.onchange = () => updateChartCabang(chartCabangDropdown.value);
        updateChartCabang(chartCabangDropdown.value);

        // Dropdown Chart Sumber Informasi
        const chartSumberDropdown = document.getElementById('chartSumberDropdown');
        const chartSumberJenisDropdown = document.getElementById('chartSumberJenisDropdown');

        // Reset options
        chartSumberDropdown.innerHTML = '<option value="all">Semua Cabang</option>';
        chartSumberJenisDropdown.innerHTML = '<option value="all">Semua Sumber</option>';
        data.cabangList.forEach(c => {
          let opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c.charAt(0) + c.slice(1).toLowerCase();
          chartSumberDropdown.appendChild(opt);
        });
        data.sumberLabels.forEach((s,i) => {
          let opt = document.createElement('option');
          opt.value = sumberOrder[i];
          opt.textContent = s.charAt(0) + s.slice(1).toLowerCase();
          chartSumberJenisDropdown.appendChild(opt);
        });

        chartSumberDropdown.onchange = () => {
          if(chartSumberDropdown.value === 'all') {
            chartSumberJenisDropdown.disabled = false;
          } else {
            chartSumberJenisDropdown.disabled = true;
            chartSumberJenisDropdown.value = 'all';
          }
          updateChartSumber(chartSumberDropdown.value, chartSumberJenisDropdown.value);
        };
        chartSumberJenisDropdown.onchange = () => {
          if(chartSumberJenisDropdown.value !== 'all') {
            chartSumberDropdown.value = 'all';
            chartSumberJenisDropdown.disabled = false;
          }
          updateChartSumber(chartSumberDropdown.value, chartSumberJenisDropdown.value);
        };
        updateChartSumber('all','all');

        // Sorting tabel
        addTableSorting('tableBranch', false);
        addTableSorting('tableSumber', false);
      })
      .catch(error => {
        document.body.removeChild(loadingIndicator);
        console.error("Error loading data:", error);
        alert('Gagal memuat data analisis. Silakan cek koneksi atau hubungi admin.');
      });
  }
  

  function updateChartCabang(type) {
    if(chartCabang) chartCabang.destroy();
    let data = globalData.branches;
    let sorted, label, datasets;
    
    // Dapatkan warna dari mode tema saat ini
    const isDarkMode = document.body.classList.contains('dark');
    const textColor = isDarkMode ? '#f3f4f6' : '#111827';
    const gridColor = isDarkMode ? 'rgba(96, 165, 250, 0.1)' : 'rgba(96, 165, 250, 0.2)';

    if(type === 'total') {
      sorted = [...data].sort((a,b) => b.jumlahPasien - a.jumlahPasien);
      label = 'Jumlah Pasien';
      datasets = [{
        label: label,
        data: sorted.map(b => b.jumlahPasien),
        backgroundColor: isDarkMode ? 'rgba(209, 213, 219, 0.8)' : 'rgba(17, 24, 39, 0.8)',
        borderColor: isDarkMode ? 'rgba(209, 213, 219, 1)' : 'rgba(17, 24, 39, 1)',
        borderWidth: 1,
        datalabels: {
          color: '#fff',
          font: { weight: 'bold' },
          align: 'end',
          anchor: 'end'
        }
      }];
    } else if(type === 'baru') {
      sorted = [...data].sort((a,b) => b.pasienBaru - a.pasienBaru);
      label = 'Pasien Baru';
      datasets = [{
        label: label,
        data: sorted.map(b => b.pasienBaru),
        backgroundColor: 'rgba(22, 163, 74, 0.8)',
        borderColor: 'rgba(22, 163, 74, 1)',
        borderWidth: 1,
        datalabels: {
          color: '#fff',
          font: { weight: 'bold' },
          align: 'end',
          anchor: 'end'
        }
      }];
    } else if(type === 'lama') {
      sorted = [...data].sort((a,b) => b.pasienLama - a.pasienLama);
      label = 'Pasien Lama';
      datasets = [{
        label: label,
        data: sorted.map(b => b.pasienLama),
        backgroundColor: 'rgba(37, 99, 235, 0.8)',
        borderColor: 'rgba(37, 99, 235, 1)',
        borderWidth: 1,
        datalabels: {
          color: '#fff',
          font: { weight: 'bold' },
          align: 'end',
          anchor: 'end'
        }
      }];
    }

    chartCabang = new Chart(document.getElementById('chartCabang').getContext('2d'), {
      type: 'bar',
      data: {
        labels: sorted.map(b => b.cabang),
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            position: 'top',
            labels: {
              color: textColor,
              font: { size: 13 }
            }
          },
          datalabels: {
            display: true,
            formatter: function(value) {
              return value < 10 ? '↑' : value;
            }
          },
          tooltip: {
            backgroundColor: isDarkMode ? 'rgba(51, 65, 85, 0.9)' : 'rgba(255, 255, 255, 0.9)',
            titleColor: isDarkMode ? '#fff' : '#000',
            bodyColor: isDarkMode ? '#fff' : '#000',
            borderColor: isDarkMode ? 'rgba(209, 213, 219, 0.5)' : 'rgba(17, 24, 39, 0.2)',
            borderWidth: 1,
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 }
          }
        },
        scales: {
          x: { 
            grid: { color: gridColor },
            ticks: { color: textColor }
          },
          y: { 
            beginAtZero: true,
            grid: { color: gridColor },
            ticks: { color: textColor }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  function updateChartSumber(cabang, sumber) {
    if(chartSumber) chartSumber.destroy();
    let labels, dataArr, colorsArr, chartType;
    
    // Dapatkan warna dari mode tema saat ini
    const isDarkMode = document.body.classList.contains('dark');
    const textColor = isDarkMode ? '#f3f4f6' : '#111827';
    const gridColor = isDarkMode ? 'rgba(96, 165, 250, 0.1)' : 'rgba(96, 165, 250, 0.2)';

    if(cabang === 'all' && sumber === 'all') {
      labels = globalData.sumberLabels;
      dataArr = globalData.sumberList;
      colorsArr = sumberColorArr;
      chartType = 'doughnut';
    } else if(cabang !== 'all' && sumber === 'all') {
      labels = globalData.sumberLabels;
      dataArr = globalData.sumberPerCabang[cabang.toUpperCase()];
      colorsArr = sumberColorArr;
      chartType = 'doughnut';
    } else if(sumber !== 'all') {
      let idx = sumberOrder.indexOf(sumber.toUpperCase());
      labels = globalData.cabangList;
      dataArr = globalData.sumberTabel[idx] ? globalData.cabangList.map(c => globalData.sumberTabel[idx][c] || 0) : [];
      colorsArr = Array(labels.length).fill(sumberColorArr[idx]);
      chartType = 'bar';
    }

    const chartOptions = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { 
          position: chartType === 'doughnut' ? 'right' : 'top',
          labels: { 
            color: textColor,
            font: { size: 13 },
            padding: 15
          }
        },
        datalabels: {
          display: true,
          color: chartType === 'doughnut' ? '#fff' : textColor,
          font: { weight: 'bold', size: 12 },
          formatter: function(value, context) { 
            if (chartType === 'doughnut') {
              const sum = context.dataset.data.reduce((a, b) => a + b, 0);
              if (sum === 0) return '';
              const percentage = (value / sum * 100).toFixed(1) + '%';
              return value > 0 ? percentage : '';
            }
            return value;
          }
        },
        tooltip: {
          backgroundColor: isDarkMode ? 'rgba(51, 65, 85, 0.9)' : 'rgba(255, 255, 255, 0.9)',
          titleColor: isDarkMode ? '#fff' : '#000',
          bodyColor: isDarkMode ? '#fff' : '#000',
          borderColor: isDarkMode ? 'rgba(209, 213, 219, 0.5)' : 'rgba(17, 24, 39, 0.2)',
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              if (chartType === 'doughnut') {
                const sum = context.dataset.data.reduce((a, b) => a + b, 0);
                if (sum === 0) return ` ${context.label}: 0`;
                const percentage = (context.parsed / sum * 100).toFixed(1) + '%';
                return ` ${context.label}: ${context.parsed} (${percentage})`;
              }
              return ` ${context.dataset.label}: ${context.parsed.y}`;
            }
          }
        }
      }
    };

    // Add scales for bar chart
    if (chartType === 'bar') {
      chartOptions.scales = {
        x: { 
          grid: { color: gridColor },
          ticks: { color: textColor }
        },
        y: { 
          beginAtZero: true,
          grid: { color: gridColor },
          ticks: { color: textColor }
        }
      };
    }

    chartSumber = new Chart(document.getElementById('chartSumber').getContext('2d'), {
      type: chartType,
      data: {
        labels: labels,
        datasets: [{
          label: sumber !== 'all' ? globalData.sumberLabels[sumberOrder.indexOf(sumber.toUpperCase())] : 'Sumber Informasi',
          data: dataArr,
          backgroundColor: colorsArr,
          borderColor: chartType === 'doughnut' ? '#fff' : colorsArr,
          borderWidth: chartType === 'doughnut' ? 2 : 1
        }]
      },
      options: chartOptions,
      plugins: [ChartDataLabels]
    });
  }

  function populateTable(tableId, data) {
    const tbody = document.getElementById(tableId).querySelector('tbody');
    tbody.innerHTML = data.map(row => `
      <tr>
        <td class="px-2 py-1 font-bold text-center">${row.cabang}</td>
        <td class="px-2 py-1 text-center">${Math.round(row.rataRataPerHari)}</td>
        <td class="px-2 py-1 text-center">${row.jumlahPasien}</td>
        <td class="px-2 py-1 text-center">${row.pasienLama}</td>
        <td class="px-2 py-1 text-center">${row.pasienBaru}</td>
        <td class="px-2 py-1 text-center">${(row.persenLama*100).toFixed(1)}%</td>
        <td class="px-2 py-1 text-center">${(row.persenBaru*100).toFixed(1)}%</td>
      </tr>
    `).join('');
  }

  // --- FUNGSI DIPERBAIKI ---
  // Fungsi ini sekarang juga membuat header tabel secara dinamis
  function populateTableSumber(tableId, sumberTabel, cabangList) {
    const table = document.getElementById(tableId);
    const theadRow = table.querySelector('thead tr');
    const tbody = table.querySelector('tbody');

    // Buat header dinamis agar semua cabang muncul
    let headerHtml = '<th>Sumber</th>';
    cabangList.forEach(cabang => {
      const displayName = cabang.charAt(0).toUpperCase() + cabang.slice(1).toLowerCase();
      headerHtml += `<th data-sort="number" class="sortable">${displayName}</th>`;
    });
    theadRow.innerHTML = headerHtml;

    // Buat isi tabel (body)
    tbody.innerHTML = sumberTabel.map((row, i) => `
      <tr>
        <td class="px-2 py-1 font-bold text-center" style="color:${sumberColorArr[i]}">${row.sumber}</td>
        ${cabangList.map(c => `<td class="px-2 py-1 text-center">${row[c] || 0}</td>`).join('')}
      </tr>
    `).join('');
  }

  function addTableSorting(tableId, allowSortFirstCol = false) {
    const table = document.getElementById(tableId);
    // Kita harus panggil ulang querySelectorAll karena header baru saja dibuat ulang
    const headers = table.querySelectorAll('th');
    headers.forEach((th, i) => {
      if(i === 0 && !allowSortFirstCol) return;
      if (!th.classList.contains('sortable')) {
        th.classList.add('sortable');
      }

      // Hapus event listener lama jika ada, untuk menghindari duplikasi
      const newTh = th.cloneNode(true);
      th.parentNode.replaceChild(newTh, th);
      
      newTh.addEventListener('click', () => {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const asc = !newTh.classList.contains('sorted-asc');
        
        // Hapus semua kelas sort dari header lain
        table.querySelectorAll('th').forEach(h => h.classList.remove('sorted-asc','sorted-desc'));
        
        // Tambah kelas sort ke header yang diklik
        newTh.classList.add(asc ? 'sorted-asc' : 'sorted-desc');
        
        rows.sort((a,b) => {
          let aText = a.children[i].textContent.trim();
          let bText = b.children[i].textContent.trim();
          let isNumber = newTh.getAttribute('data-sort') === 'number';
          
          if(isNumber) {
            aText = parseFloat(aText.replace('%','')) || 0;
            bText = parseFloat(bText.replace('%','')) || 0;
            return asc ? aText - bText : bText - aText;
          } else {
            return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
          }
        });
        
        // Tambahkan kembali baris dengan urutan yang baru
        rows.forEach(r => tbody.appendChild(r));
      });
    });
  }

  // Handle window resize for charts
  window.addEventListener('resize', function() {
    if (chartCabang) updateChartCabang(document.getElementById('chartCabangDropdown').value);
    if (chartSumber) {
      const sDropdown = document.getElementById('chartSumberDropdown');
      const jDropdown = document.getElementById('chartSumberJenisDropdown');
      updateChartSumber(sDropdown.value, jDropdown.value);
    }
  });

  // Observe for theme changes
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class' && 
          mutation.target === document.body &&
          mutation.oldValue !== document.body.className) {
        if (chartCabang) updateChartCabang(document.getElementById('chartCabangDropdown').value);
        if (chartSumber) {
          const sDropdown = document.getElementById('chartSumberDropdown');
          const jDropdown = document.getElementById('chartSumberJenisDropdown');
          updateChartSumber(sDropdown.value, jDropdown.value);
        }
      }
    });
  });
  
  observer.observe(document.body, { 
    attributes: true, 
    attributeFilter: ['class'],
    attributeOldValue: true
  });

  // Initial load - auto select current month
  document.getElementById('bulanHeader').textContent = bulanLabel[currentBulan];
  loadData();
</script>
</body>
</html>