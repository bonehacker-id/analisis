<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analisis All Cabang Bone Hacker</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <style>
    :root{
      --text-color:#111827;
      --bg-color:#ffffff;
      --card-bg:#ffffff;
      --border-color:#374151;
      --table-border:#374151;
      --shadow-color: rgba(0,0,0,0.08);
    }
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg-color);
      color:var(--text-color);
      margin:0;
    }
    .card{
      background:var(--card-bg);
      border:1px solid var(--border-color);
      border-radius:12px;
      box-shadow:0 4px 8px var(--shadow-color);
    }
    .contrast-table th, .contrast-table td{
      border:1px solid var(--table-border);
      padding:0.45rem 0.6rem;
      text-align:center;
      white-space:nowrap;
      font-size:0.85rem;
    }
    .contrast-table th{ font-weight:700; cursor:pointer; }
    .dropdown{
      border:1px solid var(--border-color);
      border-radius:6px;
      padding:0.45rem 0.75rem;
      min-width:140px;
      font-weight:600;
      background:var(--card-bg);
      color:var(--text-color);
    }
    .scroll-container{ overflow-x:auto; -webkit-overflow-scrolling:touch; padding:0.5rem 0; border-radius:8px; }
    .sumber-summary { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:12px; }
    .sumber-chip { padding:8px 10px; border-radius:999px; background:#f3f4f6; font-weight:600; font-size:0.9rem; }
    @media (max-width:640px){
      .metrics-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); }
      .contrast-table th, .contrast-table td{ font-size:0.8rem; padding:0.35rem 0.45rem; }
      .dropdown{ font-size:0.9rem; padding:0.4rem 0.6rem; }
    }
  </style>
</head>
<body>
  <main class="container mx-auto px-4 py-6 max-w-7xl">
    <header class="mb-6 text-center">
      <h1 class="text-3xl font-extrabold mb-2">Analisis All Cabang</h1>
      <p class="text-lg font-semibold mb-3">BONE HACKER <span id="bulanHeader">JANUARI 2026</span></p>

      <div class="flex flex-wrap justify-center items-center gap-3 mb-3">
        <label class="font-bold text-lg" for="bulanPicker">Pilih Bulan:</label>
        <select id="bulanPicker" class="dropdown">
          <option value="april">April 2025</option>
          <option value="mei">Mei 2025</option>
          <option value="juni">Juni 2025</option>
          <option value="juli">Juli 2025</option>
          <option value="agustus">Agustus 2025</option>
          <option value="september">September 2025</option>
          <option value="oktober">Oktober 2025</option>
          <option value="november">November 2025</option>
          <option value="desember">Desember 2025</option>
          <option value="januari" selected>Januari 2026</option>
        </select>
      </div>

      <p id="todayDate" class="text-sm mt-1 opacity-80"></p>
    </header>

    <section class="grid metrics-grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8 text-center">
      <div class="card p-4">
        <div class="text-3xl sm:text-4xl font-extrabold" id="totalPasien">-</div>
        <div class="font-semibold mt-1">Total Pasien</div>
      </div>
      <div class="card p-4">
        <div class="text-3xl sm:text-4xl font-extrabold text-green-600" id="pasienBaru">-</div>
        <div class="font-semibold mt-1">Pasien Baru</div>
      </div>
      <div class="card p-4">
        <div class="text-3xl sm:text-4xl font-extrabold text-blue-600" id="pasienLama">-</div>
        <div class="font-semibold mt-1">Pasien Lama</div>
      </div>
      <div class="card p-4">
        <div class="text-3xl sm:text-4xl font-extrabold text-orange-600" id="rataRata">-</div>
        <div class="font-semibold mt-1">Rata-rata/Hari</div>
      </div>
    </section>

    <div class="mb-6 text-center text-sm">
      <span id="persenBaru" class="font-semibold px-2 py-1 rounded bg-green-100"></span>
      <span class="mx-2">|</span>
      <span id="persenLama" class="font-semibold px-2 py-1 rounded bg-blue-100"></span>
    </div>

    <section class="card mb-8 p-5">
      <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
        <h2 class="text-xl font-bold flex-grow">Jumlah Pasien per Cabang</h2>
        <select id="chartCabangDropdown" class="dropdown">
          <option value="total">Total (Hitam)</option>
          <option value="baru">Pasien Baru (Hijau)</option>
          <option value="lama">Pasien Lama (Biru)</option>
        </select>
      </div>
      <div style="position:relative;height:320px;">
        <canvas id="chartCabang"></canvas>
      </div>
    </section>

    <section class="card mb-8 p-5">
      <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
        <h2 class="text-xl font-bold flex-grow">Sumber Informasi Pasien</h2>
        <div class="flex flex-wrap gap-2">
          <select id="chartSumberDropdown" class="dropdown">
            <option value="all">Semua Cabang</option>
          </select>
          <select id="chartSumberJenisDropdown" class="dropdown" disabled>
            <option value="all">Semua Sumber</option>
          </select>
        </div>
      </div>
      <div style="position:relative;height:320px;">
        <canvas id="chartSumber"></canvas>
      </div>

      <div id="sumberSummary" class="sumber-summary" aria-live="polite"></div>
    </section>

    <section class="card mb-8 p-5">
      <h2 class="text-xl font-bold mb-4 text-center">Tabel Data All Cabang</h2>
      <div class="scroll-container">
        <table id="tableBranch" class="min-w-full contrast-table text-sm">
          <thead>
            <tr>
              <th>Cabang</th>
              <th data-sort="number" class="sortable">RataÂ²/Hari</th>
              <th data-sort="number" class="sortable">Jumlah Pasien</th>
              <th data-sort="number" class="sortable">Pasien Lama</th>
              <th data-sort="number" class="sortable">Pasien Baru</th>
              <th data-sort="number" class="sortable">% Lama</th>
              <th data-sort="number" class="sortable">% Baru</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card mb-8 p-5">
      <h2 class="text-xl font-bold mb-4 text-center">Tabel Sumber Informasi per Cabang</h2>
      <div class="scroll-container">
        <table id="tableSumber" class="min-w-full contrast-table text-sm">
          <thead><tr></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="flex justify-center mb-8">
      <a href="https://bonehacker.com/allcabang/" target="_blank" rel="noopener" class="px-6 py-3 rounded-full bg-gray-900 text-white font-bold shadow">Lihat Daftar Antrian Hari Ini</a>
    </div>
  </main>

  <script>
    // ---------- Config ----------
    const API_MAP = {
      april: 'https://script.google.com/macros/s/AKfycby6jW-vmVgRKlBlW-gBKLfnE4FLfDkM-jxzG4kgs1mgL7IJlwlFIX0j7hNomihzaQH2jg/exec',
      mei:   'https://script.google.com/macros/s/AKfycbx5tHgTXzn0A1uxdjCYMLpb79DuURMTsNPXqPd0tLn4DG3UbtlygovWEFq73k2AdAuP/exec',
      juni:  'https://script.google.com/macros/s/AKfycbxzZWtyyfcQY3tFOyZ9fxhx6j81Kfdh7QjJvoXZCA0k9MPgOldmgSvqP_GZPvccmHPJ/exec',
      juli:  'https://script.google.com/macros/s/AKfycbzxi0ObtvJVuLJoSQwMrGHCWpnZeyPpwLD5fk8k9CCNJyCqS2m007l0mzgaDn9P3ilW/exec',
      agustus: 'https://script.google.com/macros/s/AKfycbx6-6futXmN2zM8qzIDiGUll_ShEYedkFUc_q-SodbtzghIT3xRiYwm5a3eRCvUor8r0g/exec',
      september: 'https://script.google.com/macros/s/AKfycbz8STQxgLZWJCxpVgc46CFivzlKXlPRn3T2QcWamZ8GEY0dUJr2v4jDq78csiD9goZc/exec',
      oktober: 'https://script.google.com/macros/s/AKfycbzMjq1OdGnQA8DevTAG7U2aGXkvYUKH-8o1dczTuWIaXn3W6NuXzsakapevzgk5My4LnA/exec',
      november: 'https://script.google.com/macros/s/AKfycbwTs23x2rA6TJ4cXAduWv74QY1a77a2APb8DMc3kz-smGQ0ME-BRhS9SRDxn72E_bnT/exec',
      desember: 'https://script.google.com/macros/s/AKfycbwtNMLet2bgEhiIT1dAntx7rpkrAS5K1n96F9Vajqv1g-DiZGrm10OVinOOUZdFT3LsvQ/exec',
      // <-- Added Januari 2026
      januari: 'https://script.google.com/macros/s/AKfycbxX6zkneMRRoHhewnV5ndXpVXQ40APOfzxWCFG8Uw78LMg2Ga-i4KdcjkHxejaflHTW/exec'
    };

    const bulanLabel = {
      april: "APRIL 2025",
      mei: "MEI 2025",
      juni: "JUNI 2025",
      juli: "JULI 2025",
      agustus: "AGUSTUS 2025",
      september: "SEPTEMBER 2025",
      oktober: "OKTOBER 2025",
      november: "NOVEMBER 2025",
      desember: "DESEMBER 2025",
      januari: "JANUARI 2026" // <-- Added Label
    };

    const chartColors = {
      teman: "#facc15", tiktok: "#a21caf", facebook: "#2563eb",
      lewat: "#6b7280", instagram: "#fd7e14", google: "#22c55e", youtube: "#ef4444"
    };
    const sumberOrder = ["TEMAN/KERABAT","TIKTOK","FACEBOOK","LEWAT","INSTAGRAM","GOOGLE","YOUTUBE"];
    const sumberColorArr = [chartColors.teman, chartColors.tiktok, chartColors.facebook, chartColors.lewat, chartColors.instagram, chartColors.google, chartColors.youtube];

    // DOM refs
    const bulanPicker = document.getElementById('bulanPicker');
    const bulanHeader = document.getElementById('bulanHeader');
    const todayDateEl = document.getElementById('todayDate');

    // tanggal
    const now = new Date();
    const options = { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' };
    todayDateEl.textContent = 'Tanggal: ' + now.toLocaleDateString('id-ID', options);

    // pilih bulan awal
    const monthMap = ['januari','februari','maret','april','mei','juni','juli','agustus','september','oktober','november','desember'];
    // logic auto-detect: if today is Januari, it picks 'januari' from map
    let currentBulan = monthMap[now.getMonth()] || 'mei';
    if (!API_MAP[currentBulan]) currentBulan = 'mei';
    let currentApi = API_MAP[currentBulan];

    if (bulanPicker) {
      bulanPicker.value = currentBulan;
      bulanHeader.textContent = bulanLabel[currentBulan] || bulanHeader.textContent;
      bulanPicker.addEventListener('change', () => {
        currentBulan = bulanPicker.value;
        currentApi = API_MAP[currentBulan] || currentApi;
        bulanHeader.textContent = bulanLabel[currentBulan] || bulanHeader.textContent;
        loadData();
      });
    }

    let globalData = null;
    let chartCabang = null;
    let chartSumber = null;

    function showLoading(){
      const el = document.createElement('div');
      el.id = '__loading_overlay';
      el.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50';
      el.innerHTML = `<div class="bg-white p-5 rounded-lg shadow-lg text-center">
        <div style="width:48px;height:48px;border:4px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px"></div>
        <div class="text-lg font-medium">Memuat Data...</div>
      </div>`;
      const style = document.createElement('style');
      style.textContent = `@keyframes spin{to{transform:rotate(360deg)}}`;
      el.appendChild(style);
      document.body.appendChild(el);
    }
    function hideLoading(){ const el = document.getElementById('__loading_overlay'); if (el) el.remove(); }

    function loadData(){
      if (!currentApi) { alert('API untuk bulan ini tidak tersedia.'); return; }
      showLoading();
      fetch(currentApi)
        .then(r => { if (!r.ok) throw new Error('Fetch error ' + r.status); return r.json(); })
        .then(data => {
          hideLoading();
          globalData = data || {};
          // safety defaults
          globalData.branches = globalData.branches || [];
          globalData.cabangList = globalData.cabangList || [];
          globalData.sumberLabels = globalData.sumberLabels || [];
          globalData.sumberList = globalData.sumberList || [];
          globalData.sumberPerCabang = globalData.sumberPerCabang || {};
          globalData.sumberTabel = globalData.sumberTabel || [];

          // Keep JOGJA removal for Oktober only if still desired:
          if (currentBulan === 'oktober') {
            globalData.branches = globalData.branches.filter(b => b.cabang !== 'JOGJA');
            globalData.cabangList = globalData.cabangList.filter(c => c !== 'JOGJA');
            if (globalData.sumberPerCabang && globalData.sumberPerCabang.JOGJA) delete globalData.sumberPerCabang.JOGJA;
          }

          // Rekalkulasi sumber total (semua cabang)
          if (globalData.sumberLabels.length > 0) {
            const recalculated = [];
            for (let i = 0; i < globalData.sumberLabels.length; i++) {
              let total = 0;
              for (const cab of globalData.cabangList) {
                const arr = globalData.sumberPerCabang[cab] || [];
                if (arr[i] !== undefined) total += Number(arr[i]) || 0;
              }
              recalculated.push(total);
            }
            globalData.sumberList = recalculated;
          }

          // update summary metrics
          try {
            if (data.total) {
              document.getElementById('totalPasien').textContent = data.total.jumlahPasien ?? '-';
              document.getElementById('pasienBaru').textContent = data.total.pasienBaru ?? '-';
              document.getElementById('pasienLama').textContent = data.total.pasienLama ?? '-';
              document.getElementById('rataRata').textContent = Math.round(data.total.rataRataPerHari ?? 0);
              document.getElementById('persenBaru').textContent = 'Pasien Baru: ' + ((data.total.persenBaru ?? 0) * 100).toFixed(1) + '%';
              document.getElementById('persenLama').textContent = 'Pasien Lama: ' + ((data.total.persenLama ?? 0) * 100).toFixed(1) + '%';
            } else {
              document.getElementById('totalPasien').textContent = '-';
              document.getElementById('pasienBaru').textContent = '-';
              document.getElementById('pasienLama').textContent = '-';
              document.getElementById('rataRata').textContent = '-';
            }
          } catch(e){ console.warn('Error updating totals', e); }

          // populate tables & dropdowns
          populateTable('tableBranch', globalData.branches);
          populateTableSumber('tableSumber', globalData.sumberTabel, globalData.cabangList);
          setupSumberDropdowns(globalData);

          // setup chart cabang control & initial draw
          const chartCabangDropdown = document.getElementById('chartCabangDropdown');
          chartCabangDropdown.onchange = () => updateChartCabang(chartCabangDropdown.value);
          updateChartCabang(chartCabangDropdown.value || 'total');

          // sorting
          addTableSorting('tableBranch', false);
          addTableSorting('tableSumber', false);
        })
        .catch(err => { hideLoading(); console.error('LoadData error:', err); alert('Gagal memuat data. Periksa koneksi atau API.'); });
    }

    function populateTable(tableId, rows){
      const tbody = document.getElementById(tableId).querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = rows.map(row => `
        <tr>
          <td class="px-2 py-1 font-bold text-center">${row.cabang ?? '-'}</td>
          <td class="px-2 py-1 text-center">${Math.round(row.rataRataPerHari ?? 0)}</td>
          <td class="px-2 py-1 text-center">${row.jumlahPasien ?? 0}</td>
          <td class="px-2 py-1 text-center">${row.pasienLama ?? 0}</td>
          <td class="px-2 py-1 text-center">${row.pasienBaru ?? 0}</td>
          <td class="px-2 py-1 text-center">${((row.persenLama ?? 0) * 100).toFixed(1)}%</td>
          <td class="px-2 py-1 text-center">${((row.persenBaru ?? 0) * 100).toFixed(1)}%</td>
        </tr>
      `).join('');
    }

    function populateTableSumber(tableId, sumberTabel, cabangList){
      const table = document.getElementById(tableId);
      if (!table) return;
      const theadRow = table.querySelector('thead tr');
      const tbody = table.querySelector('tbody');

      // header: Sumber + cabang + Total
      let headerHtml = '<th>Sumber</th>';
      cabangList.forEach(cabang => {
        const display = (cabang && cabang.length) ? (cabang.charAt(0) + cabang.slice(1).toLowerCase()) : cabang;
        headerHtml += `<th data-sort="number" class="sortable">${display}</th>`;
      });
      headerHtml += `<th data-sort="number" class="sortable">Total</th>`;
      theadRow.innerHTML = headerHtml;

      // rows
      tbody.innerHTML = (sumberTabel || []).map((row, idx) => {
        // calculate total for this sumber across cabangList
        let sum = 0;
        const cells = (cabangList || []).map(c => {
          const val = Number(row[c] || 0);
          sum += val;
          return `<td class="px-2 py-1 text-center">${val}</td>`;
        }).join('');
        return `
        <tr>
          <td class="px-2 py-1 font-bold text-center" style="color:${sumberColorArr[idx] || '#000'}">${row.sumber ?? 'Sumber'}</td>
          ${cells}
          <td class="px-2 py-1 text-center font-semibold">${sum}</td>
        </tr>
      `;
      }).join('');
    }

    // Setup dropdowns for sumber chart AND trigger initial draw AFTER populate
    function setupSumberDropdowns(data){
      const ddCabang = document.getElementById('chartSumberDropdown');
      const ddJenis = document.getElementById('chartSumberJenisDropdown');
      if (!ddCabang || !ddJenis) return;

      ddCabang.innerHTML = '<option value="all">Semua Cabang</option>';
      ddJenis.innerHTML = '<option value="all">Semua Sumber</option>';

      (data.cabangList || []).forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; // API uses UPPERCASE cabang names (we assume)
        opt.textContent = c.charAt(0) + c.slice(1).toLowerCase();
        ddCabang.appendChild(opt);
      });

      (data.sumberLabels || []).forEach((s, i) => {
        const opt = document.createElement('option');
        opt.value = sumberOrder[i] || s;
        opt.textContent = s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
        ddJenis.appendChild(opt);
      });

      ddCabang.onchange = () => {
        if (ddCabang.value === 'all') {
          ddJenis.disabled = false;
        } else {
          ddJenis.disabled = true;
          ddJenis.value = 'all';
        }
        updateChartSumber(ddCabang.value, ddJenis.value);
      };

      ddJenis.onchange = () => {
        if (ddJenis.value !== 'all') {
          ddCabang.value = 'all';
          ddJenis.disabled = false;
        }
        updateChartSumber(ddCabang.value, ddJenis.value);
      };

      // <-- trigger chart AFTER dropdown terisi
      updateChartSumber('all','all');
    }

    function updateSumberSummary() {
      const container = document.getElementById('sumberSummary');
      if (!globalData || !container) return;
      container.innerHTML = '';
      const labels = globalData.sumberLabels || [];
      const totals = globalData.sumberList || [];
      for (let i = 0; i < labels.length; i++) {
        const label = labels[i] || ('Sumber ' + (i+1));
        const val = totals[i] || 0;
        const el = document.createElement('div');
        el.className = 'sumber-chip';
        el.textContent = `${label}: ${val}`;
        container.appendChild(el);
      }
    }

    function updateChartCabang(type='total'){
      if (!globalData) return;
      if (chartCabang) { chartCabang.destroy(); chartCabang = null; }

      const data = globalData.branches || [];
      let sorted = [], dataset = {}, label = '';

      if (type === 'total') {
        sorted = [...data].sort((a,b) => (b.jumlahPasien||0) - (a.jumlahPasien||0));
        label = 'Jumlah Pasien';
        dataset = { label, data: sorted.map(b=>b.jumlahPasien||0), backgroundColor:'rgba(17,24,39,0.85)', borderColor:'rgba(17,24,39,1)', borderWidth:1 };
      } else if (type === 'baru') {
        sorted = [...data].sort((a,b) => (b.pasienBaru||0) - (a.pasienBaru||0));
        label = 'Pasien Baru';
        dataset = { label, data: sorted.map(b=>b.pasienBaru||0), backgroundColor:'rgba(22,163,74,0.85)', borderColor:'rgba(22,163,74,1)', borderWidth:1 };
      } else if (type === 'lama') {
        sorted = [...data].sort((a,b) => (b.pasienLama||0) - (a.pasienLama||0));
        label = 'Pasien Lama';
        dataset = { label, data: sorted.map(b=>b.pasienLama||0), backgroundColor:'rgba(37,99,235,0.85)', borderColor:'rgba(37,99,235,1)', borderWidth:1 };
      } else {
        sorted = [...data];
        label = 'Jumlah Pasien';
        dataset = { label, data: sorted.map(b=>b.jumlahPasien||0), backgroundColor:'rgba(17,24,39,0.85)', borderColor:'rgba(17,24,39,1)', borderWidth:1 };
      }

      const ctx = document.getElementById('chartCabang').getContext('2d');
      chartCabang = new Chart(ctx, {
        type: 'bar',
        data: { labels: sorted.map(b=>b.cabang||'-'), datasets: [dataset] },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ display:false },
            datalabels:{ color:'#fff', anchor:'end', align:'end', font:{ weight:'bold' }, formatter: v => v===0?'':v },
            tooltip:{ callbacks:{ label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}` } }
          },
          scales:{ x:{ grid:{ color:'rgba(96,165,250,0.08)' } }, y:{ beginAtZero:true, grid:{ color:'rgba(96,165,250,0.08)' } } }
        },
        plugins:[ChartDataLabels]
      });
    }

    function updateChartSumber(cabang='all', sumber='all'){
      if (!globalData) return;
      if (chartSumber) { chartSumber.destroy(); chartSumber = null; }

      let labels = [], dataArr = [], bg = [], type='doughnut', datasetLabel='Sumber Informasi';

      if (cabang === 'all' && sumber === 'all') {
        labels = globalData.sumberLabels || [];
        dataArr = globalData.sumberList || [];
        bg = sumberColorArr.slice(0, labels.length);
        type = 'doughnut';
      } else if (cabang !== 'all' && sumber === 'all') {
        labels = globalData.sumberLabels || [];
        const arr = globalData.sumberPerCabang[cabang] || globalData.sumberPerCabang[cabang.toUpperCase()] || [];
        dataArr = (arr || []).map(n => Number(n) || 0);
        bg = sumberColorArr.slice(0, labels.length);
        type = 'doughnut';
      } else if (sumber !== 'all') {
        const idx = sumberOrder.indexOf(sumber.toUpperCase());
        labels = globalData.cabangList || [];
        if (globalData.sumberTabel && globalData.sumberTabel[idx]) {
          const rowObj = globalData.sumberTabel[idx];
          dataArr = labels.map(c => Number(rowObj[c] || 0));
        } else {
          dataArr = labels.map(() => 0);
        }
        bg = labels.map(() => sumberColorArr[idx] || '#777');
        type = 'bar';
        datasetLabel = globalData.sumberLabels[idx] || sumber;
      } else {
        labels = globalData.sumberLabels || [];
        dataArr = globalData.sumberList || [];
        bg = sumberColorArr.slice(0, labels.length);
        type = 'doughnut';
      }

      const ctx = document.getElementById('chartSumber').getContext('2d');
      chartSumber = new Chart(ctx, {
        type,
        data: { labels, datasets: [{ label: datasetLabel, data: dataArr, backgroundColor: bg, borderColor: type==='doughnut'?'#fff':bg, borderWidth: type==='doughnut'?2:1 }] },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ display: type==='doughnut' },
            datalabels:{
              display:true,
              color: type==='doughnut' ? '#fff' : 'rgba(17,24,39,0.8)',
              formatter: function(value, ctx){
                if (type === 'doughnut') {
                  const sum = ctx.dataset.data.reduce((a,b)=>a+b,0);
                  if (!sum) return '';
                  return value>0 ? ((value/sum*100).toFixed(1) + '%') : '';
                }
                return value;
              }
            },
            tooltip:{ callbacks:{ label: function(ctx){
              if (type === 'doughnut') {
                const sum = ctx.dataset.data.reduce((a,b)=>a+b,0);
                const pct = sum ? ((ctx.parsed / sum) * 100).toFixed(1) + '%' : '0%';
                return `${ctx.label}: ${ctx.parsed} (${pct})`;
              } else {
                return `${ctx.dataset.label}: ${ctx.parsed.y}`;
              }
            } } }
          },
          scales: type==='bar' ? { x:{ grid:{ color:'rgba(96,165,250,0.08)' } }, y:{ beginAtZero:true, grid:{ color:'rgba(96,165,250,0.08)' } } } : {}
        },
        plugins:[ChartDataLabels]
      });

      // update sumber summary (chips)
      updateSumberSummary();
    }

    function addTableSorting(tableId, allowSortFirstCol=false){
      const table = document.getElementById(tableId);
      if (!table) return;
      const headers = table.querySelectorAll('th');
      headers.forEach((th, i) => {
        if (i === 0 && !allowSortFirstCol) return;
        if (!th.classList.contains('sortable')) th.classList.add('sortable');
        const newTh = th.cloneNode(true);
        th.parentNode.replaceChild(newTh, th);
        newTh.addEventListener('click', () => {
          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const asc = !newTh.classList.contains('sorted-asc');
          table.querySelectorAll('th').forEach(h => h.classList.remove('sorted-asc','sorted-desc'));
          newTh.classList.add(asc ? 'sorted-asc' : 'sorted-desc');
          rows.sort((a,b) => {
            let aText = (a.children[i].textContent || '').trim();
            let bText = (b.children[i].textContent || '').trim();
            const isNumber = newTh.getAttribute('data-sort') === 'number';
            if (isNumber) {
              aText = parseFloat(aText.replace('%','')) || 0;
              bText = parseFloat(bText.replace('%','')) || 0;
              return asc ? aText - bText : bText - aText;
            } else {
              return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
            }
          });
          rows.forEach(r => tbody.appendChild(r));
        });
      });
    }

    window.addEventListener('resize', () => {
      const chartType = document.getElementById('chartCabangDropdown').value || 'total';
      updateChartCabang(chartType);
      const sDropdown = document.getElementById('chartSumberDropdown');
      const jDropdown = document.getElementById('chartSumberJenisDropdown');
      if (sDropdown && jDropdown) updateChartSumber(sDropdown.value, jDropdown.value);
    });

    // initial load
    document.getElementById('bulanHeader').textContent = bulanLabel[currentBulan] || document.getElementById('bulanHeader').textContent;
    loadData();
  </script>
</body>
</html>



